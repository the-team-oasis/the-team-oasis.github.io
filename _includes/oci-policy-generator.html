{% comment %}
OCI Policy Generator - ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ë²”ìš© Policy ìƒì„±ê¸°

ì‚¬ìš© ì˜ˆì‹œ:
{% capture policy_config %}
{
"title": "GenAI Agent Policy ìƒì„±ê¸°",
"description": "Dynamic Groupê³¼ Compartment ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ í•„ìš”í•œ Policyë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.",
"fields": [
{
"id": "dynamicGroup",
"label": "Dynamic Group ì´ë¦„",
"placeholder": "ì˜ˆ: genai-agent-dg"
},
{
"id": "databaseComp",
"label": "Database Connection Compartment",
"placeholder": "ì˜ˆ: database-compartment"
}
],
"policies": [
"Allow dynamic-group {{dynamicGroup}} to read database-tools-family in compartment {{databaseComp}}",
"Allow any-user to use database-tools-connections in compartment {{databaseComp}} where any
{request.principal.type='genaiagent'}"
]
}
{% endcapture %}
{% include oci-policy-generator.html config=policy_config %}
{% endcomment %}

{% assign generator_id = include.id | default: "default" %}
{% assign config_json = include.config | strip | strip_newlines %}

<div class="oci-policy-generator" id="generator-{{ generator_id }}" data-config="{{ config_json | escape }}"
    style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
    <div class="generator-content">
        <div class="generator-header" style="margin-bottom: 20px;">
            <h3 style="margin-top: 0; display: flex; align-items: center;">
                <span style="margin-right: 8px;">ğŸ”§</span>
                <span class="generator-title">OCI Policy ìƒì„±ê¸°</span>
            </h3>
            <p class="generator-description" style="color: #666; font-size: 0.9em; margin-bottom: 0;">
                í•„ìš”í•œ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ Policyë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
            </p>
        </div>

        <div class="generator-form"></div>

        <button class="btn-generate"
            style="background-color: #0066cc; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 15px 0;">
            Policy ìƒì„±
        </button>

        <div class="policy-output" style="display: none; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0;">ìƒì„±ëœ Policy:</h4>
                <button class="btn-copy"
                    style="background-color: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                    ğŸ“‹ ë³µì‚¬í•˜ê¸°
                </button>
            </div>
            <pre class="generated-policy"
                style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
            <div class="copy-message" style="color: #28a745; font-weight: bold; margin-top: 10px; display: none;">
                âœ“ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
            </div>
            <div
                style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 12px; margin-top: 15px; border-radius: 4px;">
                <div style="font-size: 0.85em; color: #856404;">
                    <strong>ğŸ’¡ Compartment í‘œê¸° ì£¼ì˜:</strong> ë£¨íŠ¸ êµ¬íšì—ì„œ Policy ìƒì„± ì‹œ ì „ì²´ ê²½ë¡œ ì…ë ¥ í•„ìš” (ì˜ˆ: root:parent:child)
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .oci-policy-generator .form-group {
        margin-bottom: 15px;
    }

    .oci-policy-generator .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .oci-policy-generator .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
        box-sizing: border-box;
    }

    .oci-policy-generator input:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .oci-policy-generator button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        transition: all 0.2s;
    }

    .oci-policy-generator button:active {
        transform: translateY(0);
    }
</style>

<script>
    (function () {
        // ê° ìƒì„±ê¸° ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function () {
            const generators = document.querySelectorAll('.oci-policy-generator');

            generators.forEach(function (generator) {
                let configData = generator.getAttribute('data-config');
                let config;

                try {
                    // HTML ì—”í‹°í‹° ë””ì½”ë”©
                    const textarea = document.createElement('textarea');
                    textarea.innerHTML = configData;
                    configData = textarea.value;

                    config = JSON.parse(configData);
                    console.log('Parsed config:', config);
                    console.log('Policies:', config.policies);
                } catch (e) {
                    console.error('Policy Generator Config Parse Error:', e);
                    console.error('Config Data:', configData);
                    generator.innerHTML = '<p style="color: red;">ì„¤ì • ì˜¤ë¥˜: JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // ì œëª©ê³¼ ì„¤ëª… ì„¤ì •
                if (config.title) {
                    generator.querySelector('.generator-title').textContent = config.title;
                }
                if (config.description) {
                    generator.querySelector('.generator-description').textContent = config.description;
                }

                // í¼ í•„ë“œ ìƒì„±
                const formContainer = generator.querySelector('.generator-form');
                const generatorId = generator.getAttribute('id');
                config.fields.forEach(function (field) {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';

                    const label = document.createElement('label');
                    const uniqueId = generatorId + '-' + field.id;
                    label.setAttribute('for', uniqueId);
                    label.textContent = field.label + ':';

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = uniqueId;
                    input.setAttribute('data-field-id', field.id);
                    input.placeholder = field.placeholder || '';

                    // Enter í‚¤ë¡œ ìƒì„±
                    input.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            generatePolicy(generator, config);
                        }
                    });

                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                    formContainer.appendChild(formGroup);
                });

                // ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸
                generator.querySelector('.btn-generate').addEventListener('click', function () {
                    generatePolicy(generator, config);
                });

                // ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
                generator.querySelector('.btn-copy').addEventListener('click', function () {
                    copyPolicy(generator);
                });
            });
        });

        function generatePolicy(generator, config) {
            // ì…ë ¥ê°’ ìˆ˜ì§‘
            const values = {};
            let hasEmptyField = false;

            config.fields.forEach(function (field) {
                const input = generator.querySelector('[data-field-id="' + field.id + '"]');
                if (!input) {
                    console.error('Input not found for field:', field.id);
                    return;
                }
                const value = input.value.trim();

                if (!value) {
                    hasEmptyField = true;
                }
                values[field.id] = value;
            });

            console.log('Collected values:', values);

            if (hasEmptyField) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // Policy ìƒì„± (í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜)
            console.log('Original policies:', config.policies);
            const policies = config.policies.map(function (template) {
                console.log('Processing template:', template);
                let policy = template;
                Object.keys(values).forEach(function (key) {
                    // {{key}} ë˜ëŠ” [[key]] í˜•íƒœ ëª¨ë‘ ì§€ì›
                    const regex1 = new RegExp('\\{\\{\\s*' + key + '\\s*\\}\\}', 'g');
                    const regex2 = new RegExp('\\[\\[\\s*' + key + '\\s*\\]\\]', 'g');
                    console.log('Replacing', key, 'with', values[key]);
                    policy = policy.replace(regex1, values[key]);
                    policy = policy.replace(regex2, values[key]);
                });
                console.log('Result policy:', policy);
                return policy;
            });

            const policyText = policies.join('\n');
            console.log('Final policy text:', policyText);

            // ê²°ê³¼ í‘œì‹œ
            generator.querySelector('.generated-policy').textContent = policyText;
            generator.querySelector('.policy-output').style.display = 'block';
            generator.querySelector('.copy-message').style.display = 'none';

            // ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
            generator.querySelector('.policy-output').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function copyPolicy(generator) {
            const policyText = generator.querySelector('.generated-policy').textContent;

            navigator.clipboard.writeText(policyText).then(function () {
                const message = generator.querySelector('.copy-message');
                message.style.display = 'block';
                setTimeout(function () {
                    message.style.display = 'none';
                }, 3000);
            }).catch(function (err) {
                alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err);
            });
        }
    })();
</script>